## 객체 구성

ISLR 라이브러리에 포함된 Smarket 자료를 이용할 것이다. 이 자료는 2001년에서 2005년까지 1250일에 걸친 S&R 500주가지수의 수익률로 구성되며 각 날짜에 그날 이전 5일의 각 거래일 Lag1에서 Lag5에 대한 수익률이 기록되어 있다.
* Year: 측정 연도
* Lag1, Lag2, ..., Lag5 : 각 날짜에 그날 이전 5일의 각 거래일 Lag1에서 Lag5에 대한 수익률
* Volume: 전날에 거래된 주식 수를 10억 단위로 표시
* Today: 당일의 수익률
* Direction: 당일 주가 지수(질적변수로 Up과 Down으로 구성) 

## 기본 설정
ISLR 라이브러리에 포함된 Smarket 자료를 사용할 것이기에 아래 코드를 추가하여 데이터를 불러올 것이다.
`View 명령어`를 통해 데이터를 표 형식으로 볼 수 있다.
``` R
library(ISLR)
attach(Smarket)
View(Smarket)
```

출력:
![[Smarket_view.png]]


## 로지스틱 회귀
>Lag1, ..., Lag5와 Volume을 이용하여 Direction을 예측하는 로지스틱 회귀모델을 생성한다.

로지스틱 회귀 모델은 일반화선형모델에 적합하는 함수인`gim()` 함수에 `family=binomial` 옵션을 넣어주어 생성할 수 있다. 이에 모델을 생성하고 서머리를 출력하자.
``` R
glm.fit = glm(Direction~Lag1 + Lag2 + Lag3 + Lag4 + Lag5 + Volume, data=Smarket, family=binomial)
summary(glm.fit)
```

출력: 
``` R
Call:
glm(formula = Direction ~ Lag1 + Lag2 + Lag3 + Lag4 + Lag5 + 
    Volume, family = binomial, data = Smarket)

Deviance Residuals: 
   Min      1Q  Median      3Q     Max  
-1.446  -1.203   1.065   1.145   1.326  

Coefficients:
             Estimate Std. Error z value Pr(>|z|)
(Intercept) -0.126000   0.240736  -0.523    0.601
Lag1        -0.073074   0.050167  -1.457    0.145
Lag2        -0.042301   0.050086  -0.845    0.398
Lag3         0.011085   0.049939   0.222    0.824
Lag4         0.009359   0.049974   0.187    0.851
Lag5         0.010313   0.049511   0.208    0.835
Volume       0.135441   0.158360   0.855    0.392

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 1731.2  on 1249  degrees of freedom
Residual deviance: 1727.6  on 1243  degrees of freedom
AIC: 1741.6

Number of Fisher Scoring iterations: 3
```
>$Pr(>|z|)$는 정규분포의 절댓값이 z값의 범위를 벗어날 확률이다. 예를 들어 Lag1의 양측검정의 경우 -1.457 보다 작거나 1.457 보다 클 확률이 14.5%라는 것이다. 

<br>
predict() 함수를 사용하면 설명변수 값에 대해 주가지수가 상승할 확률을 예측할 수 있다. 이때 `type="response"` 옵션을 넣어주면 $P(Y=1|X)$ 형태의 확률(X가 $Y=1$(상승) 범위에 속해있을 확률)로 출력한다.

> 주가지수가 상승할 확률인 이유는 Direction에서 상승(Up)이 1로, 하락(Down)이 0으로 인코딩 되었기 때문이다. `contrasts(Direction)` 을 통해 확인할 수 있다. 

``` R
glm.probs = predict(glm.fit, type="response")
print(glm.probs)
```

출력:
![[glm-probs-logi.png]]

출력해보면 1250개의 값에 대한 상승할 확률이 나옴을 알 수 있다.(`dim(Smarket`)) 명령어를 통해서 알 수 있듯 본 데이터는 9개의 열과 1250개의 행(1250개의 데이터)를 가지고 있다.)
<br>
이제 예측한 값과 실제값(Direction)을 혼돈행렬을 통해 비교해보자.
``` R
# "Down" 이라는 원소를 1250개 가지는 벡터를 생성
glm.pred=rep("Down", 1250)

# 만약 glm.probs의 상승확률이 0.5보다 크면 glm.pred 벡터의 "Down" 원소를 "Up"으로 변경한다.
# glm.pred는 "Down"과 "Up"으로만 이루어진 예측값 벡터인 것이다.
glm.pred[glm.probs > .5] = "Up"

# 예측값(glm.pred) 벡터와 실제 결과(Direction)를 혼돈행렬을 통해 비교한다.
table(glm.pred, Direction)
```

출력:
``` R
        Direction
glm.pred Down  Up
    Down  145 141
    Up    457 507
```

이를 통해 민감도는 (507 + 145) / 1250 = 52.16% 이고 특이도는 (457 + 141) / 1250 = 47.84% 임을 확인 할 수 있다. 즉, 이 예에서 로지스틱 회귀는 주가지수의 움직임 방향을 52.16% 올바르게 예측하였다. 

>민감도: 실제로 참이면서 참으로 예측한 비율
>특이도: 실제로 거짓이면서 거짓으로 예측한 비율

>민감도는 각 원소가 일치할 확률의 평균과 같음으로 `mean(glm.pred == Direction)` 함수를 통해 구할 수 있다. 동일한 이유로 특이도는 `mean(glm.pred != Direction)` 함수를 통해 구할 수 있다. 

---
로지스틱 회귀는 52.16% 맞게 예측하였고 47.84% 틀리게 예측하니 무작위 추출(50%) 확률보다 긍정적으로 평가할 수 있다. 하지만 위 47.84%는 훈련오차율로 새로운 데이터를 이용한 검정오차율은 이보다 높을 가능성이 높다. 그러니 마냥 긍정적으로만 볼 수는 없다. 
<br>
>위에서 사용하였던 ISLR 라이브러리의 Smarket 데이터를 사용할 것이다.

위 자료는 2001년부터 2005년 간의 데이터를 가지고 있음으로 2001년부터 2004년까지의 데이터는 훈련데이터로, 2005년 데이터는 검증데이터로 사용하여 검정오차율을 알아보고자 한다. 

먼저 검증에 사용할 2005년 데이터를 추출해주자.
``` R
library(ISLR)
attach(Smarket)

# Year 데이터가 2005보다 작으면 TRUE 그렇지 않으면 FALSE인 원소 1250의 벡터
train = (Year < 2005)

# Smarket의 2005년 이전의 데이터를 Smarket.2005 객체에 저장한다.
# Smarket[!train,]은 Smarket 데이터에서 대응되는 train의 값이 FALSE일 때만 가져온다.(train에 !가 있기에 FALSE일 때 가져옴.)
Smarket.2005 = Smarket[!train,]

# View 명령어를 통해 객체를 표를 통해 확인해보면 모두 Year가 2005인 것을 확인할 수 있다.
# View(train.2005)

#Direction에 대해서도 2005년 자료를 분리해주자.
Direction.2005 = Direction[!train]
```


다음 2001년부터 2004년 사이의 관측치셋만 사용하여 로지스틱 회귀모델을 적합한다.
``` R
# subset 옵션을 통해 제외할 값의 범위를 설정한다. train 벡터의 TRUE 원소에 대응되는 값만 가져온다.
glm.fit = glm(Direction~Lag1 + Lag2 + Lag3 + Lag4 + Lag5 + Volume, data=Smarket, family=binomial, subset=train)
```

(2001년부터 2004년 사이의 관측치셋을 통해) 학습된 모델을 2005년 관측치셋에 대해서 검증한다. 즉, 2005년 이전의 각 날짜에 대해 주가지수가 상승할 예측확률을 얻는다. 
``` R
# glm.git 모델을 Smarket.2005 검증 데이터를 통해 검증한다.
glm.probs=predict(glm.fit, Smarket.2005, type="response")
```

이제 예측한 값과 실제값(Direction)을 혼돈행렬을 통해 비교해보자.
``` R
# 252개의 "Down" 원소를 가지는 객체를 생성
glm.pred=rep("Down", 252)

# 만약 glm.probs의 상승확률이 0.5보다 크면 glm.pred 벡터의 "Down" 원소를 "Up"으로 변경한다.
# glm.pred는 "Down"과 "Up"으로만 이루어진 예측값 벡터인 것이다.
glm.pred[glm.probs > 0.5] = "Up"

# 예측값(glm.pred) 벡터와 실제 결과(Direction.2005)를 혼돈행렬을 통해 비교한다.
table(glm.pred, Direction.2005)
```

출력: 
``` R
         Direction.2005
glm.pred Down Up
    Down   77 97
    Up     34 44
```

이를 통해 민감도는 (77 + 44) / 252 = 48.01% 이고 특이도는 (34 + 97) / 252 = 51.98% 임을 확인 할 수 있다. 즉, 이 예에서 로지스틱 회귀는 주가지수의 움직임 방향을 48.01% 올바르게 예측하였고 검정오차율은 51.98%인 것이다.

훈련오차율은 약 48%였는 반면 검정오차율은 52%라는 실망스러운 결과이다. 하지만 예견된 결과이다. $Lag_1, .., Lag_5$의 p값은 전반적으로 큰 값을 가졌으니 큰 상관관계가 없었던 것이다. 

이를 통해 반응변수와 상관관계가 없는 설명변수들은 대응하는 편향 감소 없이 분산을 증가시켜, 검정오차율을 악화시키는 경향이 있기에 이러한 설명변수들을 제외하는 것이 모델 개선을 이끌 수 있음을 확인 할 수 있다. 
실제로 p값이 그나마 작은 $Lag_1$과 $Lag_2$만을 설명변수로 사용했을 때, 56%의 확률로 예측에 성공하는 것을 확인할 수 있다. 